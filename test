
    corsPolicy:
      allowOrigins:
        {{- if $root.Values.cors.allowLocalDev }}
        - regex: "^https?://(localhost|127\\.0\\.0\\.1)(:\\d+)?$"
        {{- end }}
        - regex: "^https?://([^.]+\\.)?(dev|dev-int|staging|demo|sandbox)\\.resy\\.com(:\\d+)?$"
        - regex: "^https?://([^.]+\\.)?(americanexpress|aexp|aexplabs)\\.com(:\\d+)?$"
      allowMethods: ["DELETE","GET","POST","PATCH","OPTIONS"]
      allowHeaders:
        - "Authorization"
        - "Content-Type"
        - "Accept"
        - "X-Origin"
        - "Origin"
        - "User-Agent"
        - "X-Resy-Universal-Auth"
      exposeHeaders:
        - "pagination-count"
      maxAge: "1728000s"
      allowCredentials: true

    headers:
      response:
        set:
          Strict-Transport-Security: "max-age=31536000; includeSubDomains"
          X-Content-Type-Options: "nosniff"
          X-XSS-Protection: "1; mode=block"
        remove:
          - "server"

=====

apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: {{ include "istio-networking.fullname" . }}-security-headers
  namespace: istio-system
spec:
  {{- if $root.Values.securityHeaders.enforceAtGateway }}
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: VIRTUAL_HOST
    match:
      context: GATEWAY
    patch:
      operation: MERGE
      value:
        response_headers_to_add:
          - header:
              key: Strict-Transport-Security
              value: "max-age=31536000; includeSubDomains"
            append_action: OVERWRITE_IF_EXISTS_OR_ADD
          - header:
              key: X-Content-Type-Options
              value: "nosniff"
            append_action: OVERWRITE_IF_EXISTS_OR_ADD
          - header:
              key: X-XSS-Protection
              value: "1; mode=block"
            append_action: OVERWRITE_IF_EXISTS_OR_ADD
  {{- end }}
