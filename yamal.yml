# Self-hosted; Docker 18.x compatible; Terraspace via container
- bash: |
    set -euo pipefail

    # --- Docker up (old daemon is fine) ---
    if command -v systemctl >/dev/null 2>&1; then
      sudo systemctl start docker || true
    fi
    sudo docker version

    cd "$(Build.SourcesDirectory)"

    # --- Build the Terraspace command from inputs ---
    case "${{ parameters.action }}" in
      plan)    TS_ARGS="plan '${{ parameters.tsStack }}'  --env '${{ parameters.tsEnv }}'  --no-color --region '${{ parameters.region }}'";;
      apply)   TS_ARGS="up   '${{ parameters.tsStack }}'  --env '${{ parameters.tsEnv }}'  -y --no-color --region '${{ parameters.region }}'";;
      destroy) TS_ARGS="down '${{ parameters.tsStack }}'  --env '${{ parameters.tsEnv }}'  -y --no-color --region '${{ parameters.region }}'";;
      *) echo "Invalid action"; exit 1;;
    esac

    # --- Platform flag for very old Docker CLIs ---
    PLAT_FLAG=""
    if sudo docker run --help 2>&1 | grep -q -- '--platform'; then
      PLAT_FLAG="--platform=linux/amd64"
    fi

    # --- Pull image (fall back if --platform unsupported for pull) ---
    if ! sudo docker pull $PLAT_FLAG ghcr.io/boltops-tools/terraspace:latest; then
      sudo docker pull ghcr.io/boltops-tools/terraspace:latest
      PLAT_FLAG=""
    fi

    # --- Optional: write corporate CA to a file if provided ---
    CA_TMP="$(mktemp -d)"
    CA_FILE="$CA_TMP/ca-corp-bundle.pem"
    if [ -n "${CORP_CA_PEM:-}" ]; then
      printf '%s\n' "$CORP_CA_PEM" > "$CA_FILE"
    fi

    # --- Old 18.06 daemon knobs + low thread Ruby/Bundler ---
    LIMITS="--pids-limit 4096 --ulimit nproc=4096:8192 --ulimit nofile=65536:65536"
    SECURITY="--security-opt seccomp=unconfined --cap-add=SYS_ADMIN --cap-add=SYS_PTRACE"
    BUNDLE_ENV='export BUNDLE_JOBS=1 BUNDLE_RETRY=1 BUNDLE_FORCE_RUBY_PLATFORM=1'

    # --- Env block used inside container ---
    TF_ENV="
      export TF_IN_AUTOMATION=1 TF_INPUT=false TS_VERSION_CHECK=0;
      export TF_CLOUD_HOSTNAME='tf.puget.com';
    "

    # --- TLS trust exports (only if we wrote a CA file) ---
    TLS_ENV=""
    MOUNTS=""
    if [ -f "$CA_FILE" ]; then
      TLS_ENV="
        export SSL_CERT_FILE=/etc/ssl/certs/ca-corp-bundle.pem;
        export CURL_CA_BUNDLE=\$SSL_CERT_FILE REQUESTS_CA_BUNDLE=\$SSL_CERT_FILE;
        export AWS_CA_BUNDLE=\$SSL_CERT_FILE GIT_SSL_CAINFO=\$SSL_CERT_FILE BUNDLE_SSL_CA_CERT=\$SSL_CERT_FILE;
      "
      MOUNTS="-v $CA_FILE:/etc/ssl/certs/ca-corp-bundle.pem:ro"
    fi

    # --- Run container: install plugin if missing, init, then plan/apply ---
    sudo docker run --rm $PLAT_FLAG $LIMITS $SECURITY \
      --entrypoint /bin/sh \
      -v "$(pwd)":/workspace \
      $MOUNTS \
      -w /workspace/terraspace \
      -e TF_TOKEN_tf_puget_com \
      -e AWS_ACCESS_KEY_ID -e AWS_SECRET_ACCESS_KEY -e AWS_SESSION_TOKEN -e AWS_DEFAULT_REGION \
      ghcr.io/boltops-tools/terraspace:latest \
      -c "
        set -eu
        $BUNDLE_ENV
        $TF_ENV
        $TLS_ENV
        # Ensure the embedded Terraspace bin is on PATH
        export PATH=/opt/terraspace/embedded/bin:\$PATH
        # Make sure AWS plugin is present
        if ! gem list -i terraspace_plugin_aws >/dev/null 2>&1; then
          gem install -N terraspace_plugin_aws
        fi
        terraform -version
        terraspace -v

        # Explicit init for Terraform Cloud backends
        terraspace init '${{ parameters.tsStack }}' --env '${{ parameters.tsEnv }}' --no-color || true

        # Finally: plan/apply/destroy
        terraspace $TS_ARGS
      "
  displayName: Terraspace ${{ parameters.action }} (${{ parameters.tsStack }} / ${{ parameters.tsEnv }}) with CA + explicit init
  env:
    # Secrets
    TF_TOKEN_tf_puget_com: $(TERRAFORM_CLOUD_TOKEN)
    AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
    AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
    AWS_SESSION_TOKEN: $(AWS_SESSION_TOKEN)
    AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)
    # Paste your PEM (-----BEGIN CERTIFICATE----- â€¦) into this secret variable
    CORP_CA_PEM: $(CORP_CA_PEM)
